// Add to your existing relays array
const relays = [
  { id: 1, path: "relay1", sensorPath: "sensors/socket1", schedule: { enabled: false, onTime: null, offTime: null } },
  { id: 2, path: "relay2", sensorPath: "sensors/socket2", schedule: { enabled: false, onTime: null, offTime: null } },
  { id: 3, path: "relay3", sensorPath: "sensors/socket3", schedule: { enabled: false, onTime: null, offTime: null } },
  { id: 4, path: "relay4", sensorPath: "sensors/socket4", schedule: { enabled: false, onTime: null, offTime: null } },
];

// Add this after your relay control initialization
function initializeScheduling() {
  relays.forEach(relay => {
    const enableCheckbox = document.querySelector(`.schedule-enable[data-relay="${relay.id}"]`);
    const scheduleTimes = document.querySelector(`.schedule-enable[data-relay="${relay.id}"]`).closest('.schedule-toggle').nextElementSibling;
    
    enableCheckbox.addEventListener('change', function() {
      relay.schedule.enabled = this.checked;
      scheduleTimes.style.display = this.checked ? 'block' : 'none';
      
      if (!this.checked) {
        clearSchedule(relay.id);
      }
    });
    
    document.querySelector(`.save-schedule[data-relay="${relay.id}"]`).addEventListener('click', function() {
      saveSchedule(relay.id);
    });
    
    // Load saved schedule from localStorage
    const savedSchedule = localStorage.getItem(`relaySchedule_${relay.id}`);
    if (savedSchedule) {
      const schedule = JSON.parse(savedSchedule);
      relay.schedule = schedule;
      enableCheckbox.checked = schedule.enabled;
      scheduleTimes.style.display = schedule.enabled ? 'block' : 'none';
      
      if (schedule.enabled) {
        const onTimeInput = document.querySelector(`.on-time[data-relay="${relay.id}"]`);
        const offTimeInput = document.querySelector(`.off-time[data-relay="${relay.id}"]`);
        const onAmPm = document.querySelectorAll(`.on-time[data-relay="${relay.id}"]`).nextElementSibling;
        const offAmPm = document.querySelectorAll(`.off-time[data-relay="${relay.id}"]`).nextElementSibling;
        
        if (schedule.onTime) {
          const [hours, minutes] = schedule.onTime.split(':');
          onTimeInput.value = `${hours.padStart(2, '0')}:${minutes}`;
          onAmPm.value = hours >= 12 ? 'PM' : 'AM';
        }
        
        if (schedule.offTime) {
          const [hours, minutes] = schedule.offTime.split(':');
          offTimeInput.value = `${hours.padStart(2, '0')}:${minutes}`;
          offAmPm.value = hours >= 12 ? 'PM' : 'AM';
        }
      }
    }
  });
  
  // Check schedules every minute
  setInterval(checkSchedules, 60000);
}

function saveSchedule(relayId) {
  const relay = relays.find(r => r.id === relayId);
  if (!relay) return;
  
  const onTimeInput = document.querySelector(`.on-time[data-relay="${relayId}"]`);
  const offTimeInput = document.querySelector(`.off-time[data-relay="${relayId}"]`);
  const onAmPm = onTimeInput.nextElementSibling;
  const offAmPm = offTimeInput.nextElementSibling;
  
  // Convert to 24-hour format
  const onTime24 = convertTo24Hour(onTimeInput.value, onAmPm.value);
  const offTime24 = convertTo24Hour(offTimeInput.value, offAmPm.value);
  
  relay.schedule.onTime = onTime24;
  relay.schedule.offTime = offTime24;
  
  localStorage.setItem(`relaySchedule_${relayId}`, JSON.stringify(relay.schedule));
  alert(`Schedule for Socket ${relayId} saved successfully!`);
}

function clearSchedule(relayId) {
  const relay = relays.find(r => r.id === relayId);
  if (!relay) return;
  
  relay.schedule.onTime = null;
  relay.schedule.offTime = null;
  localStorage.removeItem(`relaySchedule_${relayId}`);
}

function convertTo24Hour(time, ampm) {
  if (!time) return null;
  
  let [hours, minutes] = time.split(':');
  hours = parseInt(hours);
  
  if (ampm === 'PM' && hours < 12) {
    hours += 12;
  } else if (ampm === 'AM' && hours === 12) {
    hours = 0;
  }
  
  return `${hours.toString().padStart(2, '0')}:${minutes}`;
}

function checkSchedules() {
  const now = new Date();
  const currentHours = now.getHours().toString().padStart(2, '0');
  const currentMinutes = now.getMinutes().toString().padStart(2, '0');
  const currentTime = `${currentHours}:${currentMinutes}`;
  
  relays.forEach(relay => {
    if (!relay.schedule.enabled) return;
    
    const db = firebase.database();
    const relayRef = db.ref("/" + relay.path);
    
    if (relay.schedule.onTime && currentTime === relay.schedule.onTime) {
      relayRef.set(true);
    }
    
    if (relay.schedule.offTime && currentTime === relay.schedule.offTime) {
      relayRef.set(false);
    }
  });
}

// Call this in your startRelayControl function after relays are initialized
initializeScheduling();
